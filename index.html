<!DOCTYPE html>
<html>
<head>
  <title>Max the Mojo Magician</title>
  <style>
    body { margin: 0; font-family: sans-serif; display: flex; height: 100vh; }
    #chat { width: 40%; border-right: 1px solid #ccc; }
    #results { width: 60%; padding: 1rem; overflow-y: auto; }
    iframe { width: 100%; height: 100%; border: none; }
    .result { border: 1px solid #ddd; margin-bottom: 1rem; padding: 1rem; border-radius: 8px; }
  </style>
</head>
<button onclick="simulateSearch()" style="position:fixed; bottom:10px; right:10px; z-index:999;">Test Firebase Write</button>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Session logic
  let sessionId = localStorage.getItem("mojoSessionId");
  if (!sessionId) {
    sessionId = crypto.randomUUID();
    localStorage.setItem("mojoSessionId", sessionId);
  }

  // Inject chatbot iframe (optional during test)
  document.getElementById("chat").innerHTML = `
    <iframe src="https://chat.chatbotbuilder.ai/chat/h201F03x4e4lBQI0?sessionId=${sessionId}"
            width="100%" height="100%" frameborder="0"></iframe>
  `;

  // Listen to updates from this session
  const sessionRef = ref(db, `sessions/${sessionId}`);
  onValue(sessionRef, snapshot => {
    const data = snapshot.val();
    if (data?.searchTerm) {
      showSearchResults(data.searchTerm);
    }
  });

  // Simulate writing to Firebase
  window.simulateSearch = function () {
    const testTerm = prompt("Enter a search term to simulate:", "hell island");
    if (testTerm) {
      set(ref(db, `sessions/${sessionId}`), { searchTerm: testTerm });
    }
  };

  // Display results
  function showSearchResults(term) {
    document.getElementById("search-term").textContent = term;
    fetch('./results.json')
      .then(res => res.json())
      .then(data => {
        const matches = data.filter(row => row.term.toLowerCase().includes(term.toLowerCase()));
        const container = document.getElementById("results");
        container.innerHTML = '';
        matches.forEach(item => {
          const div = document.createElement("div");
          div.className = "result";
          div.innerHTML = `
            <div><strong>${item.course}</strong> – ${item.module}</div>
            <div>Timestamp: ${item.timestamp}</div>
            <a href="${item.link}" target="_blank">Go to Lesson</a>
          `;
          container.appendChild(div);
        });
      });
  }
</script>
  <body>
  <!-- LEFT SIDE: Chatbot Embed -->
  <div id="chat">
    <iframe
      src="https://chat.chatbotbuilder.ai/chat/h201F03x4e4lBQI0"
      title="Max the Mojo Magician">
    </iframe>
  </div>

  <!-- RIGHT SIDE: Dynamic Search Results -->
  <div id="results">
    <h1>Results for: <span id="search-term"></span></h1>
  </div>

  <!-- JS to load results -->
  <script>
    const params = new URLSearchParams(window.location.search);
    const searchTerm = params.get("q")?.toLowerCase();
    document.getElementById("search-term").textContent = searchTerm || "None";

    fetch('./results.json')
      .then(res => res.json())
      .then(data => {
        const container = document.getElementById("results");
        const matches = data.filter(row => row.term.toLowerCase().includes(searchTerm));
        if (!matches.length) {
          container.innerHTML += "<p>No results found.</p>";
          return;
        }

        matches.forEach(item => {
          const div = document.createElement("div");
          div.className = "result";
          div.innerHTML = `
            <div><strong>${item.course}</strong> – ${item.module}</div>
            <div>Timestamp: ${item.timestamp}</div>
            <a href="${item.link}" target="_blank">Go to Lesson</a>
          `;
          container.appendChild(div);
        });
      });
  </script>
</body>
</html>

