<!DOCTYPE html>
<html>
<head>
  <title>Max the Mojo Magician</title>
  <style>
    body { margin: 0; font-family: sans-serif; display: flex; height: 100vh; }
    #chat { width: 40%; border-right: 1px solid #ccc; }
    #results { width: 60%; padding: 1rem; overflow-y: auto; }
    iframe { width: 100%; height: 100%; border: none; }
    .result { border: 1px solid #ddd; margin-bottom: 1rem; padding: 1rem; border-radius: 8px; }
  </style>
</head>
<body>

  <!-- LEFT SIDE: Embedded Max Chatbot -->
  <div id="chat">
    <iframe
      id="chatbot-iframe"
      title="Max the Mojo Magician">
    </iframe>
  </div>

  <!-- RIGHT SIDE: Dynamic Search Results -->
  <div id="results">
    <h1>Results for: <span id="search-term"></span></h1>
  </div>

  <!-- ✅ Inject Max iframe with session ID -->
  <script>
    const sessionId = localStorage.getItem("mojoSessionId") || crypto.randomUUID();
    localStorage.setItem("mojoSessionId", sessionId);

    const iframe = document.getElementById("chatbot-iframe");
    iframe.src = `https://app.chatgptbuilder.io/webchat/?p=1349554&id=h201F03x4e4lBQI0&sessionId=${sessionId}`;
  </script>

  <!-- ✅ Firebase + Search Result Sync -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDQpTZ_nnViWEEfPIz1I1GgTbQu3i5pQMM",
      authDomain: "mojo-chat-sync-test.firebaseapp.com",
      databaseURL: "https://mojo-chat-sync-test-default-rtdb.firebaseio.com",
      projectId: "mojo-chat-sync-test",
      storageBucket: "mojo-chat-sync-test.appspot.com",
      messagingSenderId: "322619127041",
      appId: "1:322619127041:web:ea086e1982cc37f03b9700"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const sessionId = localStorage.getItem("mojoSessionId");

    // ✅ Listen for Firebase updates from Max
    const sessionRef = ref(db, `sessions/${sessionId}`);
    onValue(sessionRef, snapshot => {
      const data = snapshot.val();
      if (data?.searchTerm) {
        showSearchResults(data.searchTerm);
      }
    });

    // ✅ Manual test: simulate Max writing to Firebase
    window.simulateSearch = function () {
      const testTerm = prompt("Enter a search term to simulate:", "hell island");
      if (testTerm) {
        set(ref(db, `sessions/${sessionId}`), { searchTerm: testTerm });
      }
    };

    // ✅ Render results in right panel
    function showSearchResults(term) {
      document.getElementById("search-term").textContent = term;
      fetch('./results.json')
        .then(res => res.json())
        .then(data => {
          const matches = data.filter(row => row.term.toLowerCase().includes(term.toLowerCase()));
          const container = document.getElementById("results");
          container.innerHTML = '';
          matches.forEach(item => {
            const div = document.createElement("div");
            div.className = "result";
            div.innerHTML = `
              <div><strong>${item.course}</strong> – ${item.module}</div>
              <div>Timestamp: ${item.timestamp}</div>
              <a href="${item.link}" target="_blank">Go to Lesson</a>
            `;
            container.appendChild(div);
          });
        });
    }
  </script>

  <!-- ✅ Test Button -->
  <button onclick="simulateSearch()" style="position:fixed; bottom:10px; right:10px; z-index:999;">
    Test Firebase Write
  </button>

</body>
</html>
